// Prisma schema for Seedbed
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 用户认证相关
// ============================================

model User {
  id            String    @id @default(cuid())
  slackUserId   String    @unique      // Slack User ID (唯一标识)
  slackUsername String                 // Slack 显示名
  slackTeamId   String?                // Slack 团队 ID
  email         String?                // 可选
  avatarUrl     String?                // 头像 URL
  linearToken   String?                // Linear API Token (加密存储)

  projects      Project[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// 一次性登录 Token (Slack Bot 认证)
model LoginToken {
  id            String    @id @default(cuid())
  token         String    @unique      // 随机生成的 token
  slackUserId   String                 // 关联的 Slack User ID
  slackUsername String                 // Slack 用户名
  slackTeamId   String?                // Slack 团队 ID
  expiresAt     DateTime               // 过期时间 (5 分钟)
  usedAt        DateTime?              // 使用时间 (null = 未使用)

  createdAt     DateTime  @default(now())
}

// ============================================
// 项目相关
// ============================================

model Project {
  id              String    @id @default(cuid())
  name            String
  description     String?
  userId          String
  user            User      @relation(fields: [userId], references: [id])

  // Git 连接
  gitUrl          String?
  gitBranch       String?   @default("main")
  localPath       String?              // 服务器上的本地路径

  // 提取的上下文
  techStack       String[]
  conventions     Json?

  // 计划
  plans           Plan[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
}

model Plan {
  id              String     @id @default(cuid())
  projectId       String
  project         Project    @relation(fields: [projectId], references: [id])

  name            String
  description     String?
  status          PlanStatus @default(DRAFT)

  // Claude 会话
  sessionId       String?              // Claude CLI session ID

  // 对话历史
  conversations   Conversation[]

  // 任务
  tasks           Task[]

  // Linear 同步
  linearProjectId String?
  publishedAt     DateTime?

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@index([projectId])
}

enum PlanStatus {
  DRAFT
  REVIEWING
  PUBLISHED
  ARCHIVED
}

model Task {
  id                 String   @id @default(cuid())
  planId             String
  plan               Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)

  title              String
  description        String
  priority           Int      @default(2)  // 0=P0, 1=P1, 2=P2, 3=P3
  labels             String[]

  // 验收标准
  acceptanceCriteria String[]

  // 关联文件
  relatedFiles       String[]

  // 预估
  estimateHours      Float?

  // 排序
  sortOrder          Int      @default(0)

  // 依赖
  dependsOnId        String?
  dependsOn          Task?    @relation("TaskDependency", fields: [dependsOnId], references: [id])
  dependents         Task[]   @relation("TaskDependency")

  // Linear 同步
  linearIssueId      String?

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([planId])
}

model Conversation {
  id              String   @id @default(cuid())
  planId          String
  plan            Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)

  role            String   // "user" | "assistant" | "system"
  content         String

  // 额外元数据（问题选项等）
  metadata        Json?

  createdAt       DateTime @default(now())

  @@index([planId])
}
