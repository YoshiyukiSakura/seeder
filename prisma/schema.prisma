generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  slackUserId   String    @unique
  slackUsername String
  slackTeamId   String?
  email         String?
  avatarUrl     String?
  linearToken   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  projects      Project[]
}

model LoginToken {
  id            String    @id @default(cuid())
  token         String    @unique
  slackUserId   String
  slackUsername String
  slackTeamId   String?
  expiresAt     DateTime
  usedAt        DateTime?
  createdAt     DateTime  @default(now())
}

model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  userId      String
  gitUrl      String?
  gitBranch   String?  @default("main")
  localPath   String?
  techStack   String[]
  conventions Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  plans       Plan[]
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Plan {
  id              String         @id @default(cuid())
  projectId       String
  name            String
  description     String?
  status          PlanStatus     @default(DRAFT)
  sessionId       String?
  linearProjectId String?
  publishedAt     DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  conversations   Conversation[]
  project         Project        @relation(fields: [projectId], references: [id])
  tasks           Task[]

  @@index([projectId])
}

model Task {
  id                 String   @id @default(cuid())
  planId             String
  title              String
  description        String
  priority           Int      @default(2)
  labels             String[]
  acceptanceCriteria String[]
  relatedFiles       String[]
  estimateHours      Float?
  sortOrder          Int      @default(0)
  dependsOnId        String?
  linearIssueId      String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  blockedByIds       String[] @default([])
  positionX          Float?
  positionY          Float?
  dependsOn          Task?    @relation("TaskDependency", fields: [dependsOnId], references: [id])
  dependents         Task[]   @relation("TaskDependency")
  plan               Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId])
}

model Conversation {
  id        String   @id @default(cuid())
  planId    String
  role      String
  content   String
  metadata  Json?
  createdAt DateTime @default(now())
  plan      Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId])
}

enum PlanStatus {
  DRAFT
  REVIEWING
  PUBLISHED
  ARCHIVED
}
