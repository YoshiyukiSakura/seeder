generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  slackUserId   String    @unique
  slackUsername String
  slackTeamId   String?
  email         String?
  avatarUrl     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  projects      Project[]
}

model LoginToken {
  id            String    @id @default(cuid())
  token         String    @unique
  slackUserId   String
  slackUsername String
  slackTeamId   String?
  expiresAt     DateTime
  usedAt        DateTime?
  createdAt     DateTime  @default(now())
}

model Project {
  id          String        @id @default(cuid())
  name        String
  description String?
  userId      String
  gitUrl      String?
  gitBranch   String?       @default("main")
  localPath   String?
  techStack   String[]
  conventions Json?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  plans       Plan[]
  masterPlans MasterPlan[]
  user        User          @relation(fields: [userId], references: [id])
  locks       ProjectLock[]

  @@index([userId])
}

model MasterPlan {
  id          String     @id @default(cuid())
  projectId   String
  name        String
  description String?
  status      PlanStatus @default(DRAFT)
  publishedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  project     Project    @relation(fields: [projectId], references: [id])
  plans       Plan[]

  @@index([projectId])
}

model Plan {
  id              String         @id @default(cuid())
  projectId       String
  name            String
  description     String?
  summary         String?        // LLM生成的计划摘要（发布时自动生成）
  status          PlanStatus     @default(DRAFT)
  sessionId       String?
  pendingQuestion Json?          // 存储待回答的问题数据 {toolUseId, questions}
  publishedAt     DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // MasterPlan 关联字段
  masterPlanId    String?                    // 所属主计划（可选，向后兼容）
  blockedByPlanIds String[]     @default([]) // Plan间依赖关系
  sortOrder       Int           @default(0)  // 在主计划中的排序

  conversations   Conversation[]
  project         Project        @relation(fields: [projectId], references: [id])
  masterPlan      MasterPlan?    @relation(fields: [masterPlanId], references: [id], onDelete: SetNull)
  tasks           Task[]
  executions      Execution[]

  @@index([projectId])
  @@index([masterPlanId])
}

model Task {
  id                 String            @id @default(cuid())
  planId             String
  title              String
  description        String
  priority           Int               @default(2)
  labels             String[]
  acceptanceCriteria String[]
  relatedFiles       String[]
  estimateHours      Float?
  sortOrder          Int               @default(0)
  dependsOnId        String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  blockedByIds       String[]          @default([])
  positionX          Float?
  positionY          Float?
  dependsOn          Task?             @relation("TaskDependency", fields: [dependsOnId], references: [id])
  dependents         Task[]            @relation("TaskDependency")
  plan               Plan              @relation(fields: [planId], references: [id], onDelete: Cascade)
  issueExecutions    IssueExecution[]

  @@index([planId])
}

model Conversation {
  id        String   @id @default(cuid())
  planId    String
  role      String
  content   String
  metadata  Json?
  createdAt DateTime @default(now())
  plan      Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId])
}

enum PlanStatus {
  DRAFT
  REVIEWING
  PUBLISHED
  ARCHIVED
}

// ==================== Farmer Enums ====================

enum ExecutionStatus {
  PENDING     // 等待执行
  RUNNING     // 执行中
  PAUSED      // 暂停（速率限制）
  COMPLETED   // 成功完成
  FAILED      // 执行失败
  CANCELLED   // 已取消
}

enum IssueExecutionStatus {
  PENDING       // 等待执行
  WAITING_DEPS  // 等待依赖完成
  RUNNING       // 执行中
  COMPLETED     // 成功完成
  FAILED        // 执行失败
  SKIPPED       // 已跳过（依赖失败或取消）
}

// Git 操作的细粒度状态（用于原子性追踪）
enum GitOperationStatus {
  NOT_STARTED    // 未开始
  BRANCH_CREATED // 分支已创建
  COMMITTED      // 代码已提交
  PUSHED         // 已推送到远程
  PR_CREATED     // PR 已创建
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
}

enum LogSource {
  SYSTEM    // 系统日志（Worker、调度器等）
  CLAUDE    // Claude CLI 输出
  GIT       // Git 操作
  FRONTEND  // 前端日志
  API       // API 请求日志
}

// PR 状态（用于追踪 GitHub PR 的审核状态）
enum PRStatus {
  OPEN          // PR 已打开，等待审核
  APPROVED      // PR 已通过审核
  CHANGES_REQ   // PR 需要修改
  MERGED        // PR 已合并
  CLOSED        // PR 已关闭（未合并）
}

// Merge 状态（用于追踪 Issue 级别的合并状态）
enum MergeStatus {
  NOT_MERGED    // 未合并
  MERGING       // 合并中
  MERGED        // 已合并
  CONFLICT      // 合并冲突
}

// ==================== Farmer Models ====================

model Execution {
  id           String            @id @default(cuid())
  planId       String
  status       ExecutionStatus   @default(PENDING)

  // 执行时的配置快照（防止执行中途 Project 配置变更导致不一致）
  config       Json?             // ExecutionConfig 类型

  // 渐进式发布功能开关
  // true  = 新执行器（ParallelRunner + WorktreeManager，并行执行）
  // false = 旧执行器（传统单 worktree 模式，串行处理）
  parallelMode         Boolean      @default(true)        // 新版并行执行模式开关

  // 并行执行配置（新版使用，旧版忽略）
  maxParallelIssues    Int          @default(3)           // 最大并行 Issue 数
  maxWorktreesPerIssue Int          @default(1)           // 每个 Issue 最大 worktree 数
  hasConflicts         Boolean      @default(false)       // 是否存在冲突
  conflictedIssueIds   String[]     @default([])          // 冲突的 Issue ID 列表

  // 时间信息
  startedAt    DateTime?
  completedAt  DateTime?

  // 错误信息
  error        String?

  // Git 操作状态（Execution 级别）
  gitStatus    GitOperationStatus @default(NOT_STARTED)
  branchName   String?            // Execution 的统一分支名
  prUrl        String?            // Execution 创建的 PR 链接
  prNumber     Int?               // Execution 创建的 PR 编号

  // PR 审核状态追踪
  prStatus          PRStatus?     // GitHub PR 当前状态
  prStatusSyncedAt  DateTime?     // PR 状态最后同步时间

  // 暂停相关字段（速率限制）
  pausedAt          DateTime?     // 暂停时间
  pauseReason       String?       // 暂停原因

  // 饱和度分组
  saturationGroupId String?       // 饱和度分组 ID（用于并行执行限制）

  // 审计字段
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  // 关联
  plan         Plan              @relation(fields: [planId], references: [id])
  issues       IssueExecution[]
  logs         ExecutionLog[]
  reviews      Review[]

  @@index([planId])
  @@index([status])
  @@index([createdAt])
  @@index([prStatus])
  @@index([saturationGroupId])
  @@index([parallelMode])
}

model IssueExecution {
  id              String                @id @default(cuid())
  executionId     String
  taskId          String

  // 快照字段（执行时从 Task 复制，防止 Task 被修改后数据不一致）
  taskTitle       String                // Task 标题快照
  taskDescription String                // Task 描述快照

  // 状态
  status          IssueExecutionStatus  @default(PENDING)

  // 并行执行相关字段
  worktreePath    String?               // Worktree 路径
  issueBranchName String?               // Issue 专属分支名
  mergeStatus     MergeStatus           @default(NOT_MERGED) // 合并状态
  attempt         Int                   @default(0)          // 执行尝试次数
  claimedBy       String?               // 声明该任务的 Worker ID
  claimLeaseAt    DateTime?             // 声明租约过期时间
  blockedByIds    String[]              @default([])         // 阻塞此 Issue 的其他 Issue ID
  level           Int                   @default(0)          // 依赖层级（0=无依赖）

  // Claude 会话
  claudeSessionId String?               // 用于恢复会话

  // Task 交接信息
  handoff         Json?

  // 时间信息
  startedAt       DateTime?
  completedAt     DateTime?

  // 错误处理
  error           String?
  retryCount      Int                   @default(0)
  maxRetries      Int                   @default(2)  // 最大重试次数

  // 审计字段
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  // 关联
  execution       Execution             @relation(fields: [executionId], references: [id], onDelete: Cascade)
  task            Task                  @relation(fields: [taskId], references: [id])
  logs            ExecutionLog[]

  @@index([executionId])
  @@index([taskId])
  @@index([status])
  @@index([claimedBy])
  @@index([level])
  @@index([mergeStatus])
}

model ExecutionLog {
  id               String          @id @default(cuid())
  executionId      String
  issueExecutionId String?         // 可选，关联到具体 Issue

  // 日志内容
  level            LogLevel        @default(INFO)
  source           LogSource       @default(SYSTEM)  // 日志来源
  message          String
  metadata         Json?           // LogMetadata 类型

  // 时间
  timestamp        DateTime        @default(now())

  // 关联
  execution        Execution       @relation(fields: [executionId], references: [id], onDelete: Cascade)
  issueExecution   IssueExecution? @relation(fields: [issueExecutionId], references: [id], onDelete: Cascade)

  @@index([executionId])
  @@index([issueExecutionId])
  @@index([timestamp])
  @@index([level])
  @@index([source])
}

model ProjectLock {
  id          String    @id @default(cuid())
  projectId   String    @unique    // 一个项目同时只能有一个锁
  executionId String                // 持有锁的执行

  // 锁定时间
  lockedAt    DateTime  @default(now())
  expiresAt   DateTime              // 自动过期时间（防止死锁）

  // 关联
  project     Project   @relation(fields: [projectId], references: [id])

  @@index([projectId])
  @@index([expiresAt])
}

// Worktree 级别锁，用于并发执行同一项目的多个 Plan
// 注意：executionId 不再是 @unique，允许同一执行的多个 issue 并行创建各自的 worktree
model WorktreeLock {
  id            String    @id @default(cuid())
  projectId     String                  // 所属项目
  executionId   String                  // 绑定的执行 ID（同一执行可有多个 worktree）
  worktreePath  String    @unique       // worktree 路径（全局唯一）
  branchName    String                  // 检出的分支名

  // 锁定时间
  lockedAt      DateTime  @default(now())
  expiresAt     DateTime                // 自动过期时间

  @@index([projectId])
  @@index([executionId])              // 用于查询执行的所有锁
  @@index([expiresAt])
}

// ==================== Reviewer Enums ====================

enum ReviewStatus {
  PENDING       // 等待评审
  REVIEWING     // 评审中
  COMPLETED     // 评审完成
  FAILED        // 评审失败
  APPROVED      // 已选定（择优）
  DISMISSED     // 已放弃
}

enum CommentSeverity {
  CRITICAL      // 严重问题
  MAJOR         // 主要问题
  MINOR         // 次要问题
  SUGGESTION    // 建议
  PRAISE        // 表扬
}

// ==================== Reviewer Models ====================

model Review {
  id                  String        @id @default(cuid())
  executionId         String
  prUrl               String
  prNumber            Int
  branchName          String
  // 竞争分组直接使用 execution.saturationGroupId，无需冗余字段

  // 评审状态和结果
  status              ReviewStatus  @default(PENDING)
  score               Int?          // 0-100
  reasoning           String?       // 评分理由
  summary             String?       // 代码变更总结

  // AI 使用信息
  aiModel             String?       // 使用的 AI 模型
  aiTokensUsed        Int?          // 消耗的 token 数

  // 时间信息
  startedAt           DateTime?
  completedAt         DateTime?

  // 错误信息
  error               String?

  // 择优信息
  approvedAt          DateTime?
  approvedBy          String?       // 审批人的用户 ID
  dismissedAt         DateTime?
  dismissReason       String?

  // 审计字段
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  // 关联
  execution           Execution     @relation(fields: [executionId], references: [id])
  comments            ReviewComment[]

  @@index([executionId])
  @@index([status])
  @@index([score])
}

model ReviewComment {
  id              String          @id @default(cuid())
  reviewId        String
  filePath        String
  lineNumber      Int?
  content         String
  severity        CommentSeverity
  category        String?         // 例如: security, performance, style
  suggestion      String?         // 改进建议
  createdAt       DateTime        @default(now())

  review          Review          @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId])
}
